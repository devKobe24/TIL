# UICollectionViewLayout 2ï¸âƒ£</br>

**âœï¸ `Custom Layout`ì„ ë§Œë“¤ê¸° ìœ„í•´ì„œ `UICollectionViewLayout`ì„ `Subclassing` í•´ì•¼ í•©ë‹ˆë‹¤.**</br>

**âœï¸ ëª‡ ê°€ì§€ `methods`ê°€ í•µì‹¬ ë™ì‘ì„ ë‹´ë‹¹í•˜ë©° ë‚˜ë¨¸ì§€ `methods`ëŠ” í•„ìš”ì— ë”°ë¼ `override`í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.**</br>

**âœ… í•µì‹¬ë™ì‘ì€ ëŒ€í‘œì ìœ¼ë¡œ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.**</br>

1ï¸âƒ£ ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•œ ê³µê°„ì˜ í¬ê¸° ì§€ì •.</br>
2ï¸âƒ£ CollectionViewê°€ ê° ì…€ê³¼ ë·°ì˜ ìœ„ì¹˜ë¥¼ ì§€ì •í•  ìˆ˜ ìˆë„ë¡ ë ˆì´ì•„ì›ƒì„ êµ¬ì„±í•˜ëŠ” ì…€, ë·°ì— ëŒ€í•œ attribute objects ì œê³µ</br>

## Core Layout Processì˜ ì´í•´</br>

**âœï¸ `CollectionView`ëŠ” í•„ìš”í•˜ë‹¤ê³  íŒë‹¨í•˜ë©´ `Layout` ê°ì²´ì— ì´ë¥¼ ìš”êµ¬í•©ë‹ˆë‹¤.**</br>

**ğŸ¤” ì˜ˆë¥¼ ë“¤ì–´ ì²˜ìŒ í‘œì‹œë  ë•Œ, í¬ê¸°ê°€ ì¡°ì •ë  ë ˆì´ì•„ì›ƒ ì •ë³´ë¥¼ ìš”ì²­í•©ë‹ˆë‹¤.**</br>

**âœï¸ `layout`ì˜ `invalidateLayout()`ì„ ì´ìš©í•˜ì—¬ ê¸°ì¡´ ë ˆì´ì•„ì›ƒ ì •ë³´ë¥¼ ë²„ë¦¬ê³  ìƒˆ ë ˆì´ì•„ì›ƒ ì •ë³´ë¥¼ ìƒì„±í•˜ê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.**

## invaludateLayout() VS reloadData() ğŸ¥Š</br>

**âœï¸ ë¬¸ì„œì—ì„œëŠ” `invalidateLayout()`ê³¼ `reloadData()`ê°€ ë ˆì´ì•„ì›ƒ í”„ë¡œì„¸ìŠ¤ëŠ” ë™ì¼í•˜ì§€ë§Œ ì´ ë‘ ê°€ì§€ ë©”ì„œë“œë¥¼ í˜¼ë™í•˜ì§€ ë§ë¼ê³  í•©ë‹ˆë‹¤.**</br>

ê°„ë‹¨í•œ ì‹¤í—˜ì„ í•´ë³´ì•˜ìŠµë‹ˆë‹¤.</br>

ì²« ë²ˆì§¸ ë°ì´í„° ê°’ì„ 100ìœ¼ë¡œ ë³€ê²½, ê° í•¨ìˆ˜ë¥¼ í˜¸ì¶œ, ê°ê°ì— ëŒ€í•´ì„œ UIViewProperty Animatorë¥¼ ì´ìš©í•´ ì• ë‹ˆë©”ì´ì…˜ì„ ë„£ì–´ë³´ì•˜ìŠµë‹ˆë‹¤.</br>

```swift!
UIViewPropertyAnimator(duration: 2, curve: .easeInout) { [weak self ] in 
    self?.collectionView.collectionViewLayout.invalidateLayout()
}.startAnimation()
```
```swift!
override func viewDidAppera(_ animated: Bool) {
    data[0] = 100
    sleep(3)
    collectionView.collectionViewLayout.invalidateLayout()
}
```

<img src = "https://github.com/devKobe24/images/blob/main/invalidateWithUIVIewPropertyAnimator.gif?raw=true" width = 300></br>

```swift!
override func viewDidAppear(_ animated: Bool) {
    data[0] = 100
    sleep(3)
    collectionView.reloadData()
}
```

<img src = "https://github.com/devKobe24/images/blob/main/reloadDataWithUIViewPropertyAnimator.gif?raw=true" width = 300></br>

**â›”ï¸ reloadData()ëŠ” ì• ë‹ˆë©”ì´ì…˜ì´ ë™ì‘í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ â›”ï¸**</br>

**UIViewPropertyAnimatorë¥¼ ì‚¬ìš©í•˜ì—¬ë„ UIView.animate()ë¥¼ ì‚¬ìš©í•´ë„ ë™ì¼í•œ ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤.**</br>

**ğŸ—ï¸ ê°™ì€ ë ˆì´ì•„ì›ƒ í”„ë¡œì„¸ìŠ¤ì„ì—ë„ ì• ë‹ˆë©”ì´ì…˜ì—ì„  ë‹¤ë¥¸ ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤.**</br>

**ğŸ“Œ ì• ë‹ˆë©”ì´ì…˜ ë§ê³  ë‹¤ë¥¸ ì°¨ì´ëŠ” `invalidateLayout()`ì€ ë ˆì´ì•„ì›ƒë§Œ ì—…ë°ì´íŠ¸ ë˜ì§€ë§Œ `reloadData()`ì˜ ê²½ìš° ë³€ê²½ëœ ë°ì´í„°ê¹Œì§€ ì ìš©ë©ë‹ˆë‹¤. 1ë²ˆ cellì„ ì£¼ì˜ ê¹Šê²Œ ë´ì£¼ì„¸ìš”.**</br>

**ğŸ ì• í”Œì€ `reloadData()`ëŠ” ê¼­ í•„ìš”í•  ë•Œ ì‚¬ìš©í•˜ë¼ê³  ê¶Œì¥í•©ë‹ˆë‹¤.**</br>

**ğŸ™Œ ê°œì¸ì ì¸ ìƒê°ì…ë‹ˆë‹¤ë§Œ, `invalidateLayout()`ì€ ë ˆì´ì•„ì›ƒë§Œ ì—…ë°ì´íŠ¸í•˜ê³  ì‹¶ì„ ê²½ìš°ì—ë§Œ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì„±ëŠ¥ìƒ ìœ ë¦¬í•´ë³´ì…ë‹ˆë‹¤.**

**âœ… `invalidateLayout()`ì€ ì¦‰ì‹œ ì—…ë°ì´íŠ¸ê°€ ë˜ëŠ” ê²ƒì´ ì•„ë‹Œ, ì—…ë°ì´íŠ¸ë¥¼ ì˜ˆì•½í•˜ê³ , ë‹¤ìŒ view update cycleì—ì„œ ìˆ˜í–‰ë©ë‹ˆë‹¤.**

## Layout Process</br>

<img src = "https://github.com/devKobe24/images/blob/main/layoutProcess.png?raw=true"></br>

**1ï¸âƒ£ `prepare()` í•¨ìˆ˜ë¡œ ë ˆì´ì•„ì›ƒ ì •ë³´ì— í•„ìš”í•œ ì´ˆê¸° ê³„ì‚°ì„ ì§„í–‰í•©ë‹ˆë‹¤.**</br>
**2ï¸âƒ£ `collectionViewContentSize`ë¥¼ í†µí•´ ì „ì²´ `prepare()` ê³„ì‚°ì— ê·¼ê±°í•˜ì—¬ `content` í¬ê¸°ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ `CollectionView`ëŠ” ì ì ˆí•œ `ScrollView`ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.**</br>
**3ï¸âƒ£ í˜„ì¬ ìŠ¤í¬ë¡¤ ìœ„ì¹˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ `layoutAttributesForElements(in:)`ë¥¼ í†µí•´ ì§€ì •ëœ ì‚¬ê°í˜• ë‚´ì˜ ëª¨ë“  ì…€ê³¼ ë·°ì— ëŒ€í•œ ë ˆì´ì•„ì›ƒ ì†ì„±ì„ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´ ì‚¬ê°í˜• ì˜ì—­ ë‚´ì˜ ì…€ ë° ë·°ì˜ ì†ì„±ì„ ìš”ì²­í•©ë‹ˆë‹¤. ì˜ì—­ ë‚´ì— ìˆëŠ” `UICollectionViewLayoutAttrivutes` ê°ì²´ë¥¼ ë°°ì—´ì— ì¶”ê°€í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ ì‚¬ê°í˜•ì€ ë³´ì´ëŠ” ì˜ì—­ê³¼ ê°™ì€ ìˆ˜ë„ ë‹¤ë¥¼ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.**</br>

**ğŸ—ï¸ ì´ë ‡ê²Œ í”„ë¡œì„¸ìŠ¤ê°€ ëë‚˜ë©´ `CollectionView`ì˜ `layout`ì´ `invalidate` í•  ë•Œ ê¹Œì§€ëŠ” ë ˆì´ì•„ì›ƒì„ ìœ ì§€í•©ë‹ˆë‹¤.**</br>

**ğŸ—ï¸ ë‹¤ì‹œ ë§í•´, `invalidateLayout()`ì„ í˜¸ì¶œí•˜ê±°ë‚˜, ìŠ¤í¬ë¡¤í–ˆì„ ë•Œ `shouldInvalidateLayout(forBoundsChange:)`ì´ í•¨ìˆ˜ê°€ `true`ë¥¼ ë°˜í™˜í•˜ë©´ ë‹¤ì‹œ `prepare()` ë¶€í„° ê³„ì‚°ì´ ë“¤ì–´ê°‘ë‹ˆë‹¤.**</br>

**ğŸ—ï¸ `UICollectionViewFlowLayout`ê³¼ ë‹¬ë¦¬ ë‹¨ë°©í–¥ ìŠ¤í¬ë¡¤ì„ ê°•ì œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**</br>

## Layout Attributes ìƒì„±</br>

**âœï¸ [UICollectionViewLayoutAttributes](https://developer.apple.com/documentation/uikit/uicollectionviewlayoutattributes)ëŠ” `prepareLayout method`ì—ì„œ ë§Œë“¤ê±°ë‚˜ ê¸°ë‹¤ë ¸ë‹¤ê°€ `layoutAttributesForElements(in:)` ë©”ì„œë“œì—ì„œ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.**</br>

**âœï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ìš”êµ¬ ì‚¬í•­ì— ë”°ë¼ ìš”ì²­ì„ ë°›ì„ ë•Œë§Œ `UICollectionViewLayoutAttributes`ë¥¼ ìƒì„±í•˜ëŠ” ê²Œ ì„±ëŠ¥ì´ ì¢‹ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (itemì´ ëª‡ ì²œ ê°œ ë  ê²½ìš°)**</br>

ì•„ë˜ ê³µì‹ ë¬¸ì„œ ì˜ˆì‹œ ì½”ë“œë¥¼ ë´ë´…ì‹œë‹¤.</br>

```swift!
class MosaicLayout: UICollectionViewLayout {

    var contentBounds = CGRect.zero
    var cachedAttributes = [UICollectionViewLayoutAttributes]()
    
    /// - Tag: PrepareMosaicLayout
    override func prepare() {
        super.prepare()
        
        guard let collectionView = collectionView else { return }

        // Reset cached information.
        cachedAttributes.removeAll()
        contentBounds = CGRect(origin: .zero, size: collectionView.bounds.size)
        
        // For every item in the collection view:
        //  - Prepare the attributes.
        //  - Store attributes in the cachedAttributes array.
        //  - Combine contentBounds with attributes.frame.
        let count = collectionView.numberOfItems(inSection: 0)
        
        var currentIndex = 0
        var segment: MosaicSegmentStyle = .fullWidth
        var lastFrame: CGRect = .zero
        
        let cvWidth = collectionView.bounds.size.width
        
        while currentIndex < count {
            let segmentFrame = CGRect(x: 0, y: lastFrame.maxY + 1.0, width: cvWidth, height: 200.0)
            
            var segmentRects = [CGRect]()
            switch segment {
            case .fullWidth:
                segmentRects = [segmentFrame]
                
            case .fiftyFifty:
                let horizontalSlices = segmentFrame.dividedIntegral(fraction: 0.5, from: .minXEdge)
                segmentRects = [horizontalSlices.first, horizontalSlices.second]
                
            case .twoThirdsOneThird:
                let horizontalSlices = segmentFrame.dividedIntegral(fraction: (2.0 / 3.0), from: .minXEdge)
                let verticalSlices = horizontalSlices.second.dividedIntegral(fraction: 0.5, from: .minYEdge)
                segmentRects = [horizontalSlices.first, verticalSlices.first, verticalSlices.second]
                
            case .oneThirdTwoThirds:
                let horizontalSlices = segmentFrame.dividedIntegral(fraction: (1.0 / 3.0), from: .minXEdge)
                let verticalSlices = horizontalSlices.first.dividedIntegral(fraction: 0.5, from: .minYEdge)
                segmentRects = [verticalSlices.first, verticalSlices.second, horizontalSlices.second]
            }
            
            // Create and cache layout attributes for calculated frames.
            for rect in segmentRects {
                let attributes = UICollectionViewLayoutAttributes(forCellWith: IndexPath(item: currentIndex, section: 0))
                attributes.frame = rect
                
                cachedAttributes.append(attributes)
                contentBounds = contentBounds.union(lastFrame)
                
                currentIndex += 1
                lastFrame = rect
            }

            // Determine the next segment style.
            switch count - currentIndex {
            case 1:
                segment = .fullWidth
            case 2:
                segment = .fiftyFifty
            default:
                switch segment {
                case .fullWidth:
                    segment = .fiftyFifty
                case .fiftyFifty:
                    segment = .twoThirdsOneThird
                case .twoThirdsOneThird:
                    segment = .oneThirdTwoThirds
                case .oneThirdTwoThirds:
                    segment = .fiftyFifty
                }
            }
        }
    }
 }
```

**ğŸ‘€ ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì ì€ `cachedAttributes` í”„ë¡œí¼í‹° ì„¤ì •ì„ `prepare()`ì—ì„œ í•œë‹¤ëŠ” ì ì…ë‹ˆë‹¤.**</br>

**ğŸ¤” ìš”ì²­ì„ ë°›ì„ ë•Œë§ˆë‹¤ ê³„ì‚°ì„ í•œë‹¤ëŠ” ê±´ ì•„ë˜ 3ê°€ì§€ í•¨ìˆ˜ì—ì„œ ê³„ì‚°ì„ í•˜ëŠ” ê²ƒ ì…ë‹ˆë‹¤.**</br>

**1ï¸âƒ£ [layoutAttributesForItemAtIndexPath:](https://developer.apple.com/documentation/uikit/uicollectionviewlayout/1617797-layoutattributesforitematindexpa)**</br>
**2ï¸âƒ£ [layoutAttributesForSupplementaryViewOfKind:atIndexPath:](https://developer.apple.com/documentation/uikit/uicollectionviewlayout/1617792-layoutattributesforsupplementary?language=objc)**</br>
**3ï¸âƒ£ [layoutAttributesForDecorationViewOfKind:atIndexPath:](https://developer.apple.com/documentation/uikit/uicollectionviewlayout/1617809-layoutattributesfordecorationvie?preferredLanguage=occ)**</br>

**âœï¸ ì•„ë˜ì˜ ì½”ë“œëŠ” ê·¸ ì¤‘ í•˜ë‚˜ì¸ `layoutAttributesForItem`ì…ë‹ˆë‹¤. `prepare()`ì—ì„œ ì €ì¥í•´ë‘” `catchedAttributes`ë¥¼ ì‚¬ìš©í•˜ê³  ìˆì§€ë§Œ, ì—¬ê¸°ì„œ `UICollectionViewLayoutAttributes`ì„ ìƒì„±í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.**

```swift!
override func layoutAttributesForItem(at indexPath: IndexPath) -> UICollectionViewLayoutAttributes? {
    return cachedAttributes[indexPath.item]
}
```
