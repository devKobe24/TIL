# Copy-on-Write(CoW)란?

프로그래밍 언어의 메모리 관리 기법 중 하나로, 특히 Swift에서 값 타입에 대해 많이 사용됩니다.

이 기법의 주된 목적은 메모리 사용과 성능을 최적화하는 것입니다.

**`CoW`는 객체의 복사본을 만들 필요가 있을 때, 실제로 변경 작업이 발생하기 전까지는 복사를 지연시키는 전략입니다.**

변경이 발생하면 그제서야 실제 복사가 이루어집니다.

이는 특히 큰 데이터 구조를 다룰 때 불필요한 데이터 복사를 방지하여 성능을 크게 향상시킬 수 있습니다.

## Copy-on-Write 작동 원리.

### 1. 초기 상태.

값 타입의 인스턴스가 메모리에 할당됩니다.

이 인스턴스는 여러 변수에 의해 참조될 수 있습니다.

### 2. 공유 상태.

인스턴스를 참조하는 모든 변수는 같은 메모리 주소를 가리키고 있습니다.

이 시점에서는 아직 복사본이 만들어지지 않았습니다.

### 3. 변경 시도.

인스턴스를 수정하는 연산이 발생할 때, 시스템은 해당 인스턴스가 공유되고 있는지를 검사합니다.

### 4. 복사와 할당.

- **공유 중이 아닐 때(단일 참조)** : 변경 연산은 바로 해당 메모리 주소에서 이루어집니다.
- **공유 중일 때** : 원본 인스턴스를 복사하여 새로운 메모리 주소에 할당하고, 이제 변경 연산은 새로운 복사본에 대해 수행됩니다.

## Swift에서의 CoW

`Swift`에서의 `CoW(Copy-on-Write)` 메커니즘은 주로 표준 라이브러리의 컬렉션 타입들(예: `Array`, `Dictionary`, `Set` 등)에 내장되어 있습니다.

CoW를 사용하는 이유는 값 타입의 장점을 유지하면서, 필요할 때까지는 깊은 복사를 피하여 메모리 사용과 성능을 최적화하기 위함입니다.

> 깊은 복사(Deep Copy) in Swift
> 
> 깊은 복사는 객체의 모든 내용을 새로운 메모리 영역에 복제하여 완전히 독립된 인스턴스를 생성하는 것을 말합니다.
> 
> Swift에서 클래스의 깊은 복사를 하기 위해서는 일반적으로 `NSCoping` 프로토콜을 구현하고 `copy(with:)` 메서드를 오버라이드 하여 깊은 복사 로직을 수동으로 작성해야 합니다.
> 

> 얕은 복사(Shallow Copy)in Swift
> 
> 얕은 복사는 객체의 참조만을 복사하는 것을 의미합니다.
>
> Swift에서 클래스 인스턴스를 새로운 변수에 할당할 때 기본적으로 얕은 복사가 발생합니다.
> 
> 즉, 새로운 변수는 기존의 인스턴스를 가리키는 포인터만을 복사하므로, 원본 인스턴스와 새 변수는 메모리 상의 동일한 객체를 가리키게 됩니다.

Cow는 Swift의 값 타입이 참조를 통해 공유되고 있을 때, 이 값이 변경될 때만 실제로 메모리에 복사본을 만드는 방식으로 작동합니다.

이를 통해 불필요한 복사를 방지하며, 값 타입의 불변성을 유지합니다.

**Swift에서 CoW를 구현하는 방식을 간단히 살펴보겠습니다.**

### 1. 참조 카운팅.

Swift의 값 타입 내부에는 [`isKnownUniquelyReferenced(_:)`](https://developer.apple.com/documentation/swift/isknownuniquelyreferenced(_:)-98zpp)함수를 사용하여 현재 갑시 공유되고 있는지 여부를 판단합니다.

### 2. 변형 검사.

값 타입의 인스턴스에 변경을 가하려 할 때, Swift는 먼저 `isKnownUniquelyReferenced(_:)`함수를 사용하여 참조 카운트를 확인합니다.

만약 해당 값이 고유하게 참조되고 있으면, 변경을 바로 적용할 수 있습니다.

### 3. 조건부 복사.

참조 카운트가 1보다 크면(다른 곳에서 같은 인스턴스를 참조하고 있으면), 원본의 복사본을 새로운 메모리 공간에 생성합니다.

이후 변경사항은 이 복사본에 적용되고, 원본은 그대로 유지됩니다.

이로써 변경이 필요한 경우에만 복사가 발생합니다.

### 4. 복사 후의 변경.

복사본에 대한 변경이 완료되면, 해당 변수는 새로운 복사본을 가리키게 됩니다.

원본 데이터는 다른 참조가 없어질 때까지 불변으로 유지되거나, 더 이상 필요하지 않으면 메모리에서 해제됩니다.

### 예시

예를 들어, `Array` 타입을 사용할 때, 배열을 복사하여 다른 변수에 할당하면, 내부적으로 원본 배열의 데이터를 가리키는 포인터만 복사됩니다.

그리고 복사된 배열이 변경되려 할 때 `CoW` 메커니즘이 발동하여, 실제 데이터에 대한 복사본이 생성되고 변경이 이 복사본에 적용이됩니다.

## CoW의 이점.

### 1. 성능 최적화.

데이터의 실제 복사가 필요할 때까지 복사를 지연시켜 성능을 최적화할 수 있습니다.

### 2. 메모리 효율.

불필요한 데이터 복사를 방지하여 메모리 사용을 줄일 수 있습니다.

### 3. 값 타입의 불변성.

값 타입의 불변성을 유지하면서 참조 타입의 일부 효율성을 활용할 수 있습니다.

## 주의사항

`CoW`는 자동으로 모든 값 타입에 적용되는 것은 아닙니다.

개발자가 직접 구현해야 하는 경우도 있으며,

`Swift`의 표준 라이브러리 내의 몇몇 타입들만 이 기법을 내장하고 있습니다.

따라서, 개발자가 사용자 정의 값 타입에 `CoW`를 적용하고자 할 때는 `메모리 참조 카운팅`과 `복사 로직`을 신중하게 관리해야 합니다.

## 참고 자료

- [Apple Docs: `NSCopying`](https://developer.apple.com/documentation/foundation/nscopying)
- [Apple Docs: `isKnownUniquelyReferenced(_:)`](https://developer.apple.com/documentation/swift/isknownuniquelyreferenced(_:)-98zpp)
